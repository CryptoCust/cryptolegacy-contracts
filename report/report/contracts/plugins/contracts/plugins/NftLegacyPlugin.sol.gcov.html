<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html lang="en">

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>LCOV - lcov.info - contracts/plugins/contracts/plugins/NftLegacyPlugin.sol</title>
  <link rel="stylesheet" type="text/css" href="../../../../gcov.css">
</head>

<body>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="title">LCOV - code coverage report</td></tr>
            <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>

            <tr>
              <td width="100%">
                <table cellpadding=1 border=0 width="100%">
          <tr>
            <td width="10%" class="headerItem">Current view:</td>
            <td width="10%" class="headerValue"><a href="../../../../index.html">top level</a> - <a href="index.html">contracts/plugins/contracts/plugins</a> - NftLegacyPlugin.sol<span style="font-size: 80%;"> (source / <a href="NftLegacyPlugin.sol.func-c.html">functions</a>)</span></td>
            <td width="5%"></td>
            <td width="5%"></td>
            <td width="5%" class="headerCovTableHead">Coverage</td>
            <td width="5%" class="headerCovTableHead" title="Covered + Uncovered code">Total</td>
            <td width="5%" class="headerCovTableHead" title="Exercised code only">Hit</td>
          </tr>
          <tr>
            <td class="headerItem">Test:</td>
            <td class="headerValue">lcov.info</td>
            <td></td>
            <td class="headerItem">Lines:</td>
            <td class="headerCovTableEntryHi">100.0&nbsp;%</td>
            <td class="headerCovTableEntry">54</td>
            <td class="headerCovTableEntry">54</td>
          </tr>
          <tr>
            <td class="headerItem">Test Date:</td>
            <td class="headerValue">2025-07-11 00:56:31</td>
            <td></td>
            <td class="headerItem">Functions:</td>
            <td class="headerCovTableEntryHi">100.0&nbsp;%</td>
            <td class="headerCovTableEntry">9</td>
            <td class="headerCovTableEntry">9</td>
          </tr>
          <tr>
            <td></td>
            <td></td>
            <td></td>
            <td class="headerItem">Branches:</td>
            <td class="headerCovTableEntryHi">-</td>
            <td class="headerCovTableEntry">0</td>
            <td class="headerCovTableEntry">0</td>
          </tr>
                  <tr><td><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
                </table>
              </td>
            </tr>

            <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
          </table>

          <table cellpadding=0 cellspacing=0 border=0>
            <tr>
              <td><br></td>
            </tr>
            <tr>
              <td>
<pre class="sourceHeading">             Branch data     Line data    Source code</pre>
<pre class="source">
<span id="L1"><span class="lineNum">       1</span>                 :             : /*</span>
<span id="L2"><span class="lineNum">       2</span>                 :             : * Copyright (c) 2024 CryptoCustoms. All Rights Reserved.</span>
<span id="L3"><span class="lineNum">       3</span>                 :             : */</span>
<span id="L4"><span class="lineNum">       4</span>                 :             : </span>
<span id="L5"><span class="lineNum">       5</span>                 :             : pragma solidity 0.8.24;</span>
<span id="L6"><span class="lineNum">       6</span>                 :             : </span>
<span id="L7"><span class="lineNum">       7</span>                 :             : import &quot;../libraries/LibDiamond.sol&quot;;</span>
<span id="L8"><span class="lineNum">       8</span>                 :             : import &quot;../interfaces/ICryptoLegacy.sol&quot;;</span>
<span id="L9"><span class="lineNum">       9</span>                 :             : import &quot;../libraries/LibCryptoLegacy.sol&quot;;</span>
<span id="L10"><span class="lineNum">      10</span>                 :             : import &quot;../interfaces/ICryptoLegacyPlugin.sol&quot;;</span>
<span id="L11"><span class="lineNum">      11</span>                 :             : import &quot;@openzeppelin/contracts/token/ERC721/IERC721.sol&quot;;</span>
<span id="L12"><span class="lineNum">      12</span>                 :             : import &quot;@openzeppelin/contracts-upgradeable/utils/ReentrancyGuardUpgradeable.sol&quot;;</span>
<span id="L13"><span class="lineNum">      13</span>                 :             : </span>
<span id="L14"><span class="lineNum">      14</span>                 :             : /**</span>
<span id="L15"><span class="lineNum">      15</span>                 :             :  * @title NftLegacyPlugin</span>
<span id="L16"><span class="lineNum">      16</span>                 :             :  * @notice Extends CryptoLegacy functionality to support NFT asset inheritance. It allows setting NFT beneficiaries, transferring NFTs into the inheritance contract, and claiming them after specified delays, seamlessly integrating NFTs into legacy plans.</span>
<span id="L17"><span class="lineNum">      17</span>                 :             : */</span>
<span id="L18"><span class="lineNum">      18</span>                 :             : contract NftLegacyPlugin is ICryptoLegacyPlugin, ReentrancyGuardUpgradeable {</span>
<span id="L19"><span class="lineNum">      19</span>                 :             :     bytes32 public constant PLUGIN_POSITION = keccak256(&quot;nft_legacy.plugin.storage&quot;);</span>
<span id="L20"><span class="lineNum">      20</span>                 :             : </span>
<span id="L21"><span class="lineNum">      21</span>                 :             :     event SetNftBeneficiary(address indexed nftContract, uint256 indexed tokenId, bytes32 indexed beneficiaryHash);</span>
<span id="L22"><span class="lineNum">      22</span>                 :             :     event BeneficiaryClaimNft(address indexed nftContract, uint256 indexed tokenId, bytes32 indexed beneficiaryHash, address beneficiaryAddress);</span>
<span id="L23"><span class="lineNum">      23</span>                 :             :     event TransferNftToCryptoLegacy(address indexed nftContract, uint256 indexed tokenId);</span>
<span id="L24"><span class="lineNum">      24</span>                 :             : </span>
<span id="L25"><span class="lineNum">      25</span>                 :             :     /**</span>
<span id="L26"><span class="lineNum">      26</span>                 :             :      * @notice Returns the list of function selectors provided by this plugin.</span>
<span id="L27"><span class="lineNum">      27</span>                 :             :      * @dev These selectors represent the externally callable functions of the NFT plugin.</span>
<span id="L28"><span class="lineNum">      28</span>                 :             :      * @return sigs An array of function selectors.</span>
<span id="L29"><span class="lineNum">      29</span>                 :             :      */</span>
<span id="L30"><span class="lineNum">      30</span>                 :<span class="tlaGNC tlaBgGNC">          25 :     function getSigs() external pure returns (bytes4[] memory sigs) {</span></span>
<span id="L31"><span class="lineNum">      31</span>                 :<span class="tlaGNC">          25 :         sigs = new bytes4[](3);</span></span>
<span id="L32"><span class="lineNum">      32</span>                 :<span class="tlaGNC">          25 :         sigs[0] = this.setNftBeneficiary.selector;</span></span>
<span id="L33"><span class="lineNum">      33</span>                 :<span class="tlaGNC">          25 :         sigs[1] = this.transferNftTokensToLegacy.selector;</span></span>
<span id="L34"><span class="lineNum">      34</span>                 :<span class="tlaGNC">          25 :         sigs[2] = this.beneficiaryClaimNft.selector;</span></span>
<span id="L35"><span class="lineNum">      35</span>                 :             :     }</span>
<span id="L36"><span class="lineNum">      36</span>                 :             : </span>
<span id="L37"><span class="lineNum">      37</span>                 :             :     /**</span>
<span id="L38"><span class="lineNum">      38</span>                 :             :      * @notice Returns the setup function selectors for this plugin.</span>
<span id="L39"><span class="lineNum">      39</span>                 :             :      * @dev This plugin does not require any setup functions.</span>
<span id="L40"><span class="lineNum">      40</span>                 :             :      * @return sigs An empty array of function selectors.</span>
<span id="L41"><span class="lineNum">      41</span>                 :             :      */</span>
<span id="L42"><span class="lineNum">      42</span>                 :<span class="tlaGNC">           7 :     function getSetupSigs() external pure returns (bytes4[] memory sigs) {</span></span>
<span id="L43"><span class="lineNum">      43</span>                 :<span class="tlaGNC">           7 :         sigs = new bytes4[](0);</span></span>
<span id="L44"><span class="lineNum">      44</span>                 :             :     }</span>
<span id="L45"><span class="lineNum">      45</span>                 :             :     /**</span>
<span id="L46"><span class="lineNum">      46</span>                 :             :      * @notice Returns the unique name for this plugin.</span>
<span id="L47"><span class="lineNum">      47</span>                 :             :      * @dev The name is used for identification purposes across the CryptoLegacy ecosystem.</span>
<span id="L48"><span class="lineNum">      48</span>                 :             :      * @return A string representing the plugin name.</span>
<span id="L49"><span class="lineNum">      49</span>                 :             :      */</span>
<span id="L50"><span class="lineNum">      50</span>                 :<span class="tlaGNC">           1 :     function getPluginName() external pure returns (string memory) {</span></span>
<span id="L51"><span class="lineNum">      51</span>                 :<span class="tlaGNC">           1 :         return &quot;nft_legacy&quot;;</span></span>
<span id="L52"><span class="lineNum">      52</span>                 :             :     }</span>
<span id="L53"><span class="lineNum">      53</span>                 :             :     /**</span>
<span id="L54"><span class="lineNum">      54</span>                 :             :      * @notice Returns the version number for this plugin.</span>
<span id="L55"><span class="lineNum">      55</span>                 :             :      * @dev The version returned is encoded as a uint16.</span>
<span id="L56"><span class="lineNum">      56</span>                 :             :      * @return The plugin version.</span>
<span id="L57"><span class="lineNum">      57</span>                 :             :      */</span>
<span id="L58"><span class="lineNum">      58</span>                 :<span class="tlaGNC">           1 :     function getPluginVer() external pure returns (uint16) {</span></span>
<span id="L59"><span class="lineNum">      59</span>                 :<span class="tlaGNC">           1 :         return uint16(1);</span></span>
<span id="L60"><span class="lineNum">      60</span>                 :             :     }</span>
<span id="L61"><span class="lineNum">      61</span>                 :             : </span>
<span id="L62"><span class="lineNum">      62</span>                 :             :     /**</span>
<span id="L63"><span class="lineNum">      63</span>                 :             :      * @notice Struct representing the NFT beneficiary configuration.</span>
<span id="L64"><span class="lineNum">      64</span>                 :             :      * @dev Contains the hashed beneficiary address and a delay value determining when a beneficiary may claim the NFT.</span>
<span id="L65"><span class="lineNum">      65</span>                 :             :      * @param addressHash The keccak256 hash of the beneficiary's address.</span>
<span id="L66"><span class="lineNum">      66</span>                 :             :      * @param claimDelay The delay (in seconds) after distribution starts before the NFT becomes claimable.</span>
<span id="L67"><span class="lineNum">      67</span>                 :             :      */</span>
<span id="L68"><span class="lineNum">      68</span>                 :             :     struct NftBeneficiary {</span>
<span id="L69"><span class="lineNum">      69</span>                 :             :         bytes32 addressHash;</span>
<span id="L70"><span class="lineNum">      70</span>                 :             :         uint64 claimDelay;</span>
<span id="L71"><span class="lineNum">      71</span>                 :             :     }</span>
<span id="L72"><span class="lineNum">      72</span>                 :             :     /**</span>
<span id="L73"><span class="lineNum">      73</span>                 :             :      * @notice Plugin storage for NFT legacy functionality.</span>
<span id="L74"><span class="lineNum">      74</span>                 :             :      * @dev Maps an NFT contract and token ID to a defined beneficiary.</span>
<span id="L75"><span class="lineNum">      75</span>                 :             :      */</span>
<span id="L76"><span class="lineNum">      76</span>                 :             :     struct PluginStorage {</span>
<span id="L77"><span class="lineNum">      77</span>                 :             :         mapping (address =&gt; mapping (uint256 =&gt; NftBeneficiary)) nftBeneficiary;</span>
<span id="L78"><span class="lineNum">      78</span>                 :             :     }</span>
<span id="L79"><span class="lineNum">      79</span>                 :             : </span>
<span id="L80"><span class="lineNum">      80</span>                 :             :     /**</span>
<span id="L81"><span class="lineNum">      81</span>                 :             :      * @notice Retrieves the plugin storage using a fixed storage slot.</span>
<span id="L82"><span class="lineNum">      82</span>                 :             :      * @dev Uses inline assembly to assign a storage slot based on PLUGIN_POSITION.</span>
<span id="L83"><span class="lineNum">      83</span>                 :             :      * @return storageStruct A reference to the PluginStorage struct.</span>
<span id="L84"><span class="lineNum">      84</span>                 :             :      */</span>
<span id="L85"><span class="lineNum">      85</span>                 :<span class="tlaGNC">          29 :     function getPluginStorage() internal pure returns (PluginStorage storage storageStruct) {</span></span>
<span id="L86"><span class="lineNum">      86</span>                 :<span class="tlaGNC">          29 :         bytes32 position = PLUGIN_POSITION;</span></span>
<span id="L87"><span class="lineNum">      87</span>                 :             :         assembly {</span>
<span id="L88"><span class="lineNum">      88</span>                 :<span class="tlaGNC">          29 :             storageStruct.slot := position</span></span>
<span id="L89"><span class="lineNum">      89</span>                 :             :         }</span>
<span id="L90"><span class="lineNum">      90</span>                 :             :     }</span>
<span id="L91"><span class="lineNum">      91</span>                 :             : </span>
<span id="L92"><span class="lineNum">      92</span>                 :             :     /**</span>
<span id="L93"><span class="lineNum">      93</span>                 :             :      * @notice Modifier that restricts function access to the owner.</span>
<span id="L94"><span class="lineNum">      94</span>                 :             :      * @dev Invokes LibCryptoLegacy._checkOwner() to verify that msg.sender is the contract owner.</span>
<span id="L95"><span class="lineNum">      95</span>                 :             :      */</span>
<span id="L96"><span class="lineNum">      96</span>                 :<span class="tlaGNC">          10 :     modifier onlyOwner() {</span></span>
<span id="L97"><span class="lineNum">      97</span>                 :<span class="tlaGNC">          10 :         LibCryptoLegacy._checkOwner();</span></span>
<span id="L98"><span class="lineNum">      98</span>                 :             :         _;</span>
<span id="L99"><span class="lineNum">      99</span>                 :             :     }</span>
<span id="L100"><span class="lineNum">     100</span>                 :             : </span>
<span id="L101"><span class="lineNum">     101</span>                 :             :     /**</span>
<span id="L102"><span class="lineNum">     102</span>                 :             :      * @notice Sets the NFT beneficiary for a list of token IDs from a given NFT contract.</span>
<span id="L103"><span class="lineNum">     103</span>                 :             :      * @dev Can only be called by the owner. For each token ID, stores the beneficiary hash and claim delay.</span>
<span id="L104"><span class="lineNum">     104</span>                 :             :      * Emits a SetNftBeneficiary event for each token.</span>
<span id="L105"><span class="lineNum">     105</span>                 :             :      * @param _beneficiary The keccak256 hash of the beneficiary's address.</span>
<span id="L106"><span class="lineNum">     106</span>                 :             :      * @param _nftContract The address of the NFT contract.</span>
<span id="L107"><span class="lineNum">     107</span>                 :             :      * @param _tokenIds An array of NFT token IDs.</span>
<span id="L108"><span class="lineNum">     108</span>                 :             :      * @param _delay The claim delay (in seconds) before the NFT can be claimed.</span>
<span id="L109"><span class="lineNum">     109</span>                 :             :      */</span>
<span id="L110"><span class="lineNum">     110</span>                 :<span class="tlaGNC">          10 :     function setNftBeneficiary(bytes32 _beneficiary, address _nftContract, uint256[] memory _tokenIds, uint32 _delay) public onlyOwner {</span></span>
<span id="L111"><span class="lineNum">     111</span>                 :<span class="tlaGNC">           8 :         PluginStorage storage pluginStorage = getPluginStorage();</span></span>
<span id="L112"><span class="lineNum">     112</span>                 :<span class="tlaGNC">           8 :         for (uint256 i = 0; i &lt; _tokenIds.length; i++) {</span></span>
<span id="L113"><span class="lineNum">     113</span>                 :<span class="tlaGNC">           9 :             pluginStorage.nftBeneficiary[_nftContract][_tokenIds[i]] = NftBeneficiary({addressHash: _beneficiary, claimDelay: _delay});</span></span>
<span id="L114"><span class="lineNum">     114</span>                 :<span class="tlaGNC">           9 :             emit SetNftBeneficiary(_nftContract, _tokenIds[i], _beneficiary);</span></span>
<span id="L115"><span class="lineNum">     115</span>                 :             :         }</span>
<span id="L116"><span class="lineNum">     116</span>                 :             :     }</span>
<span id="L117"><span class="lineNum">     117</span>                 :             : </span>
<span id="L118"><span class="lineNum">     118</span>                 :             :     /**</span>
<span id="L119"><span class="lineNum">     119</span>                 :             :      * @notice Transfers NFT tokens from their current owners into the CryptoLegacy contract.</span>
<span id="L120"><span class="lineNum">     120</span>                 :             :      * @dev Checks that distribution is ready; then for each token:</span>
<span id="L121"><span class="lineNum">     121</span>                 :             :      *   - Verifies that a beneficiary has been set.</span>
<span id="L122"><span class="lineNum">     122</span>                 :             :      *   - Transfers the token from its current owner to the contract.</span>
<span id="L123"><span class="lineNum">     123</span>                 :             :      * Requirements:</span>
<span id="L124"><span class="lineNum">     124</span>                 :             :      * - Distribution must be ready.</span>
<span id="L125"><span class="lineNum">     125</span>                 :             :      * - If the caller is not the nft beneficiary (as determined by their hash) then they must have a nonzero share.</span>
<span id="L126"><span class="lineNum">     126</span>                 :             :      * @param _nftContract The address of the NFT contract.</span>
<span id="L127"><span class="lineNum">     127</span>                 :             :      * @param _tokenIds An array of token IDs to transfer.</span>
<span id="L128"><span class="lineNum">     128</span>                 :             :      */</span>
<span id="L129"><span class="lineNum">     129</span>                 :<span class="tlaGNC">           8 :     function transferNftTokensToLegacy(address _nftContract, uint256[] memory _tokenIds) public nonReentrant {</span></span>
<span id="L130"><span class="lineNum">     130</span>                 :<span class="tlaGNC">           8 :         ICryptoLegacy.CryptoLegacyStorage storage cls = LibCryptoLegacy.getCryptoLegacyStorage();</span></span>
<span id="L131"><span class="lineNum">     131</span>                 :             : </span>
<span id="L132"><span class="lineNum">     132</span>                 :<span class="tlaGNC">           8 :         LibCryptoLegacy._checkDistributionReady(cls);</span></span>
<span id="L133"><span class="lineNum">     133</span>                 :<span class="tlaGNC">           8 :         bytes32 senderHash = LibCryptoLegacy._addressToHash(msg.sender);</span></span>
<span id="L134"><span class="lineNum">     134</span>                 :<span class="tlaGNC">           8 :         bool senderIsBeneficiary = false;</span></span>
<span id="L135"><span class="lineNum">     135</span>                 :             : </span>
<span id="L136"><span class="lineNum">     136</span>                 :<span class="tlaGNC">           8 :         PluginStorage storage pluginStorage = getPluginStorage();</span></span>
<span id="L137"><span class="lineNum">     137</span>                 :<span class="tlaGNC">           8 :         for (uint256 i = 0; i &lt; _tokenIds.length; i++) {</span></span>
<span id="L138"><span class="lineNum">     138</span>                 :<span class="tlaGNC">          15 :             address tokenOwner = IERC721(_nftContract).ownerOf(_tokenIds[i]);</span></span>
<span id="L139"><span class="lineNum">     139</span>                 :<span class="tlaGNC">          15 :             NftBeneficiary memory beneficiary = pluginStorage.nftBeneficiary[_nftContract][_tokenIds[i]];</span></span>
<span id="L140"><span class="lineNum">     140</span>            [<span class="tlaGBC" title="Branch 0 was taken 1 time"> + </span>]:<span class="tlaGNC">          15 :             if (beneficiary.addressHash == bytes32(0)) {</span></span>
<span id="L141"><span class="lineNum">     141</span>                 :<span class="tlaGNC">           1 :                 revert ICryptoLegacy.BeneficiaryNotSet();</span></span>
<span id="L142"><span class="lineNum">     142</span>                 :             :             }</span>
<span id="L143"><span class="lineNum">     143</span>            [<span class="tlaGBC" title="Branch 0 was taken 7 times"> + </span>]:<span class="tlaGNC">          14 :             if (beneficiary.addressHash == senderHash) {</span></span>
<span id="L144"><span class="lineNum">     144</span>                 :<span class="tlaGNC">           7 :                 senderIsBeneficiary = true;</span></span>
<span id="L145"><span class="lineNum">     145</span>                 :             :             }</span>
<span id="L146"><span class="lineNum">     146</span>                 :<span class="tlaGNC">          14 :             IERC721(_nftContract).transferFrom(tokenOwner, address(this), _tokenIds[i]);</span></span>
<span id="L147"><span class="lineNum">     147</span>                 :<span class="tlaGNC">          13 :             emit TransferNftToCryptoLegacy(_nftContract, _tokenIds[i]);</span></span>
<span id="L148"><span class="lineNum">     148</span>                 :             :         }</span>
<span id="L149"><span class="lineNum">     149</span>                 :             : </span>
<span id="L150"><span class="lineNum">     150</span>            [<span class="tlaGBC" title="Branch 0 was taken 1 time"> + </span>]:<span class="tlaGNC">           6 :         if (!senderIsBeneficiary &amp;&amp; cls.beneficiaryConfig[senderHash].shareBps == uint64(0)) {</span></span>
<span id="L151"><span class="lineNum">     151</span>                 :<span class="tlaGNC">           1 :             revert ICryptoLegacy.NotTheBeneficiary();</span></span>
<span id="L152"><span class="lineNum">     152</span>                 :             :         }</span>
<span id="L153"><span class="lineNum">     153</span>                 :             :     }</span>
<span id="L154"><span class="lineNum">     154</span>                 :             : </span>
<span id="L155"><span class="lineNum">     155</span>                 :             :     /**</span>
<span id="L156"><span class="lineNum">     156</span>                 :             :      * @notice Allows the designated beneficiary to claim NFT tokens.</span>
<span id="L157"><span class="lineNum">     157</span>                 :             :      * @dev For each token ID:</span>
<span id="L158"><span class="lineNum">     158</span>                 :             :      *   - Verifies that the caller is the designated beneficiary.</span>
<span id="L159"><span class="lineNum">     159</span>                 :             :      *   - Checks that the current time is at least distributionStartAt + claimDelay.</span>
<span id="L160"><span class="lineNum">     160</span>                 :             :      *   - Transfers the token from the contract to the caller.</span>
<span id="L161"><span class="lineNum">     161</span>                 :             :      * Requirements:</span>
<span id="L162"><span class="lineNum">     162</span>                 :             :      * - Caller’s beneficiary hash must match.</span>
<span id="L163"><span class="lineNum">     163</span>                 :             :      * - The claim delay condition must be met.</span>
<span id="L164"><span class="lineNum">     164</span>                 :             :      * @param _nftContract The address of the NFT contract.</span>
<span id="L165"><span class="lineNum">     165</span>                 :             :      * @param _tokenIds An array of token IDs to claim.</span>
<span id="L166"><span class="lineNum">     166</span>                 :             :      */</span>
<span id="L167"><span class="lineNum">     167</span>                 :<span class="tlaGNC">          14 :     function beneficiaryClaimNft(address _nftContract, uint256[] memory _tokenIds) public nonReentrant {</span></span>
<span id="L168"><span class="lineNum">     168</span>                 :<span class="tlaGNC">          14 :         ICryptoLegacy.CryptoLegacyStorage storage cls = LibCryptoLegacy.getCryptoLegacyStorage();</span></span>
<span id="L169"><span class="lineNum">     169</span>                 :             : </span>
<span id="L170"><span class="lineNum">     170</span>            [<span class="tlaGBC" title="Branch 0 was taken 1 time"> + </span>]:<span class="tlaGNC">          14 :         if (_tokenIds.length == 0) {</span></span>
<span id="L171"><span class="lineNum">     171</span>                 :<span class="tlaGNC">           1 :             revert ICryptoLegacy.ZeroTokens();</span></span>
<span id="L172"><span class="lineNum">     172</span>                 :             :         }</span>
<span id="L173"><span class="lineNum">     173</span>                 :<span class="tlaGNC">          13 :         LibCryptoLegacy._checkDistributionReady(cls);</span></span>
<span id="L174"><span class="lineNum">     174</span>                 :<span class="tlaGNC">          13 :         bytes32 senderHash = LibCryptoLegacy._addressToHash(msg.sender);</span></span>
<span id="L175"><span class="lineNum">     175</span>                 :             : </span>
<span id="L176"><span class="lineNum">     176</span>                 :<span class="tlaGNC">          13 :         PluginStorage storage pluginStorage = getPluginStorage();</span></span>
<span id="L177"><span class="lineNum">     177</span>                 :<span class="tlaGNC">          13 :         for (uint256 i = 0; i &lt; _tokenIds.length; i++) {</span></span>
<span id="L178"><span class="lineNum">     178</span>                 :<span class="tlaGNC">          14 :             address tokenOwner = IERC721(_nftContract).ownerOf(_tokenIds[i]);</span></span>
<span id="L179"><span class="lineNum">     179</span>                 :<span class="tlaGNC">          14 :             NftBeneficiary memory beneficiary = pluginStorage.nftBeneficiary[_nftContract][_tokenIds[i]];</span></span>
<span id="L180"><span class="lineNum">     180</span>            [<span class="tlaGBC" title="Branch 0 was taken 3 times"> + </span>]:<span class="tlaGNC">          14 :             if (beneficiary.addressHash != senderHash) {</span></span>
<span id="L181"><span class="lineNum">     181</span>                 :<span class="tlaGNC">           3 :                 revert ICryptoLegacy.NotTheBeneficiary();</span></span>
<span id="L182"><span class="lineNum">     182</span>                 :             :             }</span>
<span id="L183"><span class="lineNum">     183</span>            [<span class="tlaGBC" title="Branch 0 was taken 4 times"> + </span>]:<span class="tlaGNC">          11 :             if (uint64(block.timestamp) &lt; beneficiary.claimDelay + cls.distributionStartAt) {</span></span>
<span id="L184"><span class="lineNum">     184</span>                 :<span class="tlaGNC">           4 :                revert ICryptoLegacy.DistributionDelay();</span></span>
<span id="L185"><span class="lineNum">     185</span>                 :             :             }</span>
<span id="L186"><span class="lineNum">     186</span>                 :             : </span>
<span id="L187"><span class="lineNum">     187</span>                 :<span class="tlaGNC">           7 :             IERC721(_nftContract).transferFrom(tokenOwner, msg.sender, _tokenIds[i]);</span></span>
<span id="L188"><span class="lineNum">     188</span>                 :<span class="tlaGNC">           6 :             emit BeneficiaryClaimNft(_nftContract, _tokenIds[i], beneficiary.addressHash, msg.sender);</span></span>
<span id="L189"><span class="lineNum">     189</span>                 :             :         }</span>
<span id="L190"><span class="lineNum">     190</span>                 :             :     }</span>
<span id="L191"><span class="lineNum">     191</span>                 :             : }</span>
        </pre>
              </td>
            </tr>
          </table>
          <br>

          <table width="100%" border=0 cellspacing=0 cellpadding=0>
            <tr><td class="ruler"><img src="../../../../glass.png" width=3 height=3 alt=""></td></tr>
            <tr><td class="versionInfo">Generated by: <a href="https://github.com//linux-test-project/lcov" target="_parent">LCOV version 2.0-1</a></td></tr>
          </table>
          <br>

</body>
</html>
